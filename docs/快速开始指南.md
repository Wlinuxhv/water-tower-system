# 🚀 快速开始指南

5 分钟内完成水塔监控系统的基础配置！

---

## 📦 第一步：准备硬件

### 主机 (ESP8266)

- [ ] NodeMCU 或 WeMos D1 × 1
- [ ] PAN3031 LoRa 模块 × 1
- [ ] OLED 显示屏 (0.96" I2C) × 1
- [ ] 缺水传感器 × 1
- [ ] 杜邦线若干

### 从机 (STC32G) - 每个水塔一个

- [ ] STC32G12K128 开发板 × 1
- [ ] PAN3031 LoRa 模块 × 1
- [ ] 液位传感器 × 1
- [ ] 继电器模块 × 1
- [ ] 缺水传感器 × 1
- [ ] 拨码开关 (2 位或更多) × 1

---

## 🔧 第二步：硬件连接

### 主机接线

按照 [硬件接线图](硬件接线图.md) 连接：

```
ESP8266 ←→ OLED
D1 (GPIO5) ←→ SCL
D2 (GPIO4) ←→ SDA
3.3V ←→ VCC
GND ←→ GND

ESP8266 ←→ PAN3031
D5 (GPIO14) ←→ CSN
D6 (GPIO12) ←→ MISO
D7 (GPIO13) ←→ MOSI
D8 (GPIO15) ←→ SCK
D4 (GPIO2) ←→ IRQ
3.3V ←→ VCC
GND ←→ GND

ESP8266 ←→ 缺水传感器
D0 (GPIO16) ←→ OUT
3.3V ←→ VCC
GND ←→ GND
```

### 从机接线

```
STC32G ←→ PAN3031
P1.3 ←→ CSN
P1.0 ←→ MISO
P1.1 ←→ MOSI
P1.2 ←→ SCK
P1.4 ←→ IRQ
3.3V ←→ VCC
GND ←→ GND

STC32G ←→ 液位传感器
P2.0 (ADC) ←→ OUT
5V ←→ VCC
GND ←→ GND

STC32G ←→ 继电器
P3.4 ←→ IN
5V ←→ VCC
GND ←→ GND

STC32G ←→ 缺水传感器
P2.1 ←→ OUT
5V ←→ VCC
GND ←→ GND

STC32G ←→ 拨码开关
P5.4 ←→ A
P5.5 ←→ B
```

---

## 💻 第三步：烧录程序

### 烧录从机程序 (STC32G)

1. **下载 SDCC 编译器**
   - Windows: https://sourceforge.net/projects/sdcc/files/
   - 或使用预编译的 HEX 文件

2. **编译程序**
   ```bash
   cd slave_node
   make
   ```

3. **烧录到芯片**
   - 打开 STC-ISP 工具
   - 选择芯片型号：STC32G12K128
   - 加载 HEX 文件：`build/main.hex`
   - 点击"下载/编程"
   - 冷启动开发板

4. **设置从机地址**
   - 拨码开关设置地址 (0x01-0xFE)
   - 第一个从机：0x01 (A=ON, B=OFF)
   - 第二个从机：0x02 (A=OFF, B=ON)
   - 以此类推...

### 烧录主机程序 (ESP8266)

**方法 1: 使用 PlatformIO (推荐)**

1. 安装 VS Code
2. 安装 PlatformIO 扩展
3. 打开 `esp8266_master` 文件夹
4. 点击 PlatformIO 侧边栏
5. 点击 "Upload"

**方法 2: 使用 Arduino IDE**

1. 安装 Arduino IDE
2. 添加 ESP8266 开发板支持:
   - 文件 → 首选项 → 附加开发板管理器 URL
   - 添加：`http://arduino.esp8266.com/stable/package_esp8266com_index.json`
3. 安装开发板:
   - 工具 → 开发板 → 开发板管理器
   - 搜索 "ESP8266" 并安装
4. 选择开发板：NodeMCU 1.0
5. 选择端口：COMx (Windows) 或 /dev/ttyUSBx (Linux)
6. 上传程序

---

## 📱 第四步：配置 WiFi

编辑 `esp8266_master/src/main.cpp`:

```cpp
// 修改为你的 WiFi 信息
const char* WIFI_SSID = "你的 WiFi 名称";
const char* WIFI_PASS = "你的 WiFi 密码";
```

重新烧录主机程序。

---

## 📲 第五步：安装 Android APP

### 方法 1: 直接安装 APK

1. 下载最新 APK:
   - 前往 [Releases](https://github.com/Wlinuxhv/water-tower-system/releases)
   - 下载 `water-tower-monitor-v1.0.apk`

2. 安装到手机:
   - 传输 APK 到手机
   - 允许"未知来源"安装
   - 点击安装

### 方法 2: 自己编译

1. 安装 Android Studio
2. 打开 `android_app` 项目
3. 等待 Gradle 同步完成
4. 点击 "Build" → "Build Bundle(s) / APK(s)" → "Build APK(s)"
5. APK 位置：`app/build/outputs/apk/debug/app-debug.apk`

---

## ✅ 第六步：系统测试

### 1. 上电从机

- 给所有从机上电
- 观察继电器是否短暂吸合 (自检)
- 串口调试输出应显示:
  ```
  STC32G 水塔节点启动
  地址：0x01
  PAN3031 初始化成功
  发送心跳包...
  ```

### 2. 上电主机

- 给主机上电
- OLED 应显示:
  ```
  水塔监控系统
  版本：1.0.0
  WiFi: OK
  ```
- 串口调试输出应显示:
  ```
  === 水塔监控系统启动 ===
  OLED 初始化成功
  PAN3031 初始化成功
  连接 WiFi: YourWiFiSSID
  WiFi 连接成功!
  IP 地址：192.168.1.xxx
  ```

### 3. 测试通信

- 主机应自动发现从机
- OLED 显示各水塔水位
- 串口输出:
  ```
  收到心跳包 地址：0x01 水位：45%
  水塔 1 在线
  ```

### 4. 测试 APP

1. 手机连接同一 WiFi
2. 打开水塔监控 APP
3. 输入 ESP8266 的 IP 地址
4. 点击连接
5. 应能看到各水塔水位

### 5. 测试水泵控制

**手动模式:**
1. APP 切换到手动模式
2. 点击某个水塔的水泵开关
3. 从机继电器应吸合/释放
4. OLED 显示水泵状态变化

**自动模式:**
1. APP 切换到自动模式
2. 遮挡液位传感器 (模拟低水位)
3. 水泵应自动开启
4. 水位恢复正常后自动关闭

### 6. 测试缺水保护

1. 触发缺水传感器 (模拟井水缺水)
2. 所有水泵应立即关闭
3. OLED 显示"缺水!"警告
4. APP 推送报警通知

---

## 🔍 故障排查

### 问题：从机无法上线

**检查:**
- [ ] 从机地址设置是否正确
- [ ] PAN3031 接线是否正确
- [ ] 天线是否连接
- [ ] 从机与主机距离是否太远

**解决:**
1. 检查串口输出，确认 PAN3031 初始化成功
2. 使用频谱仪或 SDR 检查是否有 434MHz 信号
3. 尝试缩短天线或靠近主机测试

### 问题：WiFi 连接失败

**检查:**
- [ ] WiFi 名称和密码是否正确
- [ ] WiFi 是否为 2.4GHz (ESP8266 不支持 5GHz)
- [ ] 信号强度是否足够

**解决:**
1. 检查串口输出中的 WiFi 连接日志
2. 尝试使用手机热点测试
3. 确保 WiFi 密码没有特殊字符

### 问题：APP 无法连接

**检查:**
- [ ] 手机和 ESP8266 是否在同一网络
- [ ] IP 地址是否正确
- [ ] 防火墙是否阻止 80 端口

**解决:**
1. 在浏览器访问 `http://ESP8266_IP/api/status`
2. 检查是否返回 JSON 数据
3. 尝试关闭手机防火墙或使用其他网络

### 问题：水位显示不准确

**检查:**
- [ ] 液位传感器供电是否稳定
- [ ] ADC 参考电压是否正确
- [ ] 传感器是否安装正确

**解决:**
1. 使用万用表测量传感器输出电压
2. 在代码中调整 ADC 校准参数
3. 确保传感器垂直安装

---

## 📞 获取帮助

- 📖 查看 [系统设计文档](系统设计文档.md)
- 🔌 查看 [硬件接线图](硬件接线图.md)
- 🐛 提交 Issue: https://github.com/Wlinuxhv/water-tower-system/issues
- 💬 讨论区：https://github.com/Wlinuxhv/water-tower-system/discussions

---

**祝你使用愉快！** 🎉

如有问题，请随时在 GitHub 上提问。
