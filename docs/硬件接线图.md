# 🔌 硬件接线图

## 主机 (ESP8266 Master)

### 引脚分配

| ESP8266 引脚 | 连接设备 | 功能 | 备注 |
|-------------|---------|------|------|
| GPIO4 (D2) | OLED SDA | I2C 数据 | 内部上拉 |
| GPIO5 (D1) | OLED SCL | I2C 时钟 | 内部上拉 |
| GPIO12 (D6) | PAN3031 MISO | SPI 数据输入 | |
| GPIO13 (D7) | PAN3031 MOSI | SPI 数据输出 | |
| GPIO14 (D5) | PAN3031 SCK | SPI 时钟 | |
| GPIO15 (D8) | PAN3031 CSN | SPI 片选 | 低电平有效 |
| GPIO0 (D3) | PAN3031 IRQ | 中断请求 | 上升沿触发 |
| GPIO2 (D4) | 缺水传感器 | 数字输入 | 高=缺水 |
| 3.3V | PAN3031 VCC | 电源 | 最大 200mA |
| GND | 所有设备 GND | 共地 | |

### 接线示意图

```
                    ESP8266 (NodeMCU/WeMos)
                    ┌─────────────────────────┐
                    │                         │
     OLED SDA ──────┤ GPIO4 (D2)              │
     OLED SCL ──────┤ GPIO5 (D1)              │
     PAN3031 MISO ──┤ GPIO12 (D6)             │
     PAN3031 MOSI ──┤ GPIO13 (D7)             │
     PAN3031 SCK ───┤ GPIO14 (D5)             │
     PAN3031 CSN ───┤ GPIO15 (D8)             │
     PAN3031 IRQ ───┤ GPIO0 (D3)              │
     缺水检测 ──────┤ GPIO2 (D4)              │
                    │                         │
                    │  3.3V ───┬── OLED VCC   │
                    │          └── PAN3031 VCC│
                    │                         │
                    │  GND ────┬── OLED GND   │
                    │          ├── PAN3031 GND│
                    │          └── 缺水 GND   │
                    │                         │
                    └─────────────────────────┘

OLED (0.96" I2C)
┌────────────────┐
│ VCC ───────────┼── 3.3V
│ GND ───────────┼── GND
│ SDA ───────────┼── GPIO4 (D2)
│ SCL ───────────┼── GPIO5 (D1)
└────────────────┘

PAN3031 LoRa 模块
┌────────────────┐
│ VCC ───────────┼── 3.3V
│ GND ───────────┼── GND
│ MISO ──────────┼── GPIO12 (D6)
│ MOSI ──────────┼── GPIO13 (D7)
│ SCK ───────────┼── GPIO14 (D5)
│ CSN ───────────┼── GPIO15 (D8)
│ IRQ ───────────┼── GPIO0 (D3)
└────────────────┘

缺水传感器 (光电液位开关)
┌────────────────┐
│ VCC ───────────┼── 3.3V
│ GND ───────────┼── GND
│ OUT ───────────┼── GPIO2 (D4)
└────────────────┘
```

---

## 从机 (STC32G Slave)

### 引脚分配

| STC32G 引脚 | 连接设备 | 功能 | 备注 |
|------------|---------|------|------|
| P3.0 (RXD) | 调试串口 TX | UART 输出 | 115200 波特率 |
| P3.1 (TXD) | 调试串口 RX | UART 输入 | |
| P1.0 | PAN3031 MISO | SPI 数据输入 | |
| P1.1 | PAN3031 MOSI | SPI 数据输出 | |
| P1.2 | PAN3031 SCK | SPI 时钟 | |
| P1.3 | PAN3031 CSN | SPI 片选 | 低电平有效 |
| P1.4 | PAN3031 IRQ | 中断请求 | 上升沿触发 |
| P2.0 | 液位传感器 | ADC 输入 | 0-3.3V |
| P2.1 | 缺水检测 | 数字输入 | 高=缺水 |
| P3.4 | 继电器 IN | 水泵控制 | 高=开启 |
| P5.4 | 地址开关 A | 拨码开关 | 地址位 0 |
| P5.5 | 地址开关 B | 拨码开关 | 地址位 1 |
| 5V | 继电器 VCC | 电源 | |
| GND | 所有设备 GND | 共地 | |

### 接线示意图

```
                    STC32G12K128
                    ┌─────────────────────────┐
                    │                         │
     调试 TX ───────┤ P3.0 (RXD)              │
     调试 RX ───────┤ P3.1 (TXD)              │
     PAN3031 MISO ──┤ P1.0                    │
     PAN3031 MOSI ──┤ P1.1                    │
     PAN3031 SCK ───┤ P1.2                    │
     PAN3031 CSN ───┤ P1.3                    │
     PAN3031 IRQ ───┤ P1.4                    │
     液位传感器 ────┤ P2.0 (ADC)              │
     缺水检测 ──────┤ P2.1                    │
     继电器 ────────┤ P3.4                    │
     地址 A ────────┤ P5.4                    │
     地址 B ────────┤ P5.5                    │
                    │                         │
                    │  5V ─────┬── 继电器 VCC │
                    │          └── 传感器 VCC │
                    │                         │
                    │  GND ────┬── 继电器 GND │
                    │          ├── 传感器 GND │
                    │          └── LoRa GND   │
                    │                         │
                    └─────────────────────────┘

PAN3031 LoRa 模块
┌────────────────┐
│ VCC ───────────┼── 3.3V (LDO 从 5V 转换)
│ GND ───────────┼── GND
│ MISO ──────────┼── P1.0
│ MOSI ──────────┼── P1.1
│ SCK ───────────┼── P1.2
│ CSN ───────────┼── P1.3
│ IRQ ───────────┼── P1.4
└────────────────┘

液位传感器 (投入式液位变送器)
┌────────────────┐
│ VCC ───────────┼── 5V
│ GND ───────────┼── GND
│ OUT ───────────┼── P2.0 (ADC)
└────────────────┘
注意：传感器输出 0-3.3V，如超过需加分压电阻

缺水传感器 (光电液位开关)
┌────────────────┐
│ VCC ───────────┼── 5V
│ GND ───────────┼── GND
│ OUT ───────────┼── P2.1
└────────────────┘

继电器模块 (5V)
┌────────────────┐
│ VCC ───────────┼── 5V
│ GND ───────────┼── GND
│ IN ────────────┼── P3.4
│ COM ───────────┼── 水泵电源
│ NO  ───────────┼── 水泵正极
└────────────────┘
```

### 拨码开关地址配置

```
        ┌────────────┐
        │ 拨码开关   │
        │ ON  OFF    │
   A ───┤ SW1        ├── P5.4
   B ───┤ SW2        ├── P5.5
        └────────────┘

地址 = (B << 1) | A

SW2  SW1   地址
OFF  OFF   0x00 (保留给主机)
OFF  ON    0x01 (从机 1)
ON   OFF   0x02 (从机 2)
ON   ON    0x03 (从机 3)

可扩展到 8 位拨码开关，支持 254 个从机
```

---

## 电源设计

### 主机供电

```
12V DC 输入
    │
    ▼
┌─────────────┐
│ DC-DC 模块  │  12V → 5V
│ 12V→5V 2A   │
└─────────────┘
    │
    ├──────────────┬─────────────┐
    ▼              ▼             ▼
┌───────┐    ┌──────────┐  ┌──────────┐
│ LDO   │    │ 继电器   │  │ 传感器   │
│ 5V→3.3V│    │ (可选)   │  │ (可选)   │
└───────┘    └──────────┘  └──────────┘
    │
    ▼
ESP8266 + OLED + PAN3031
```

### 从机供电

```
12V/24V DC 输入 (根据水泵电压)
    │
    ▼
┌─────────────┐
│ DC-DC 模块  │  12V/24V → 5V
│ 5V 3A       │
└─────────────┘
    │
    ├──────────────┬─────────────┬─────────────┐
    ▼              ▼             ▼             ▼
┌───────┐    ┌──────────┐  ┌──────────┐  ┌──────────┐
│ LDO   │    │ 继电器   │  │ 液位     │  │ 缺水     │
│ 5V→3.3V│    │ 线圈     │  │ 传感器   │  │ 传感器   │
└───────┘    └──────────┘  └──────────┘  └──────────┘
    │
    ▼
STC32G + PAN3031
```

---

## PCB 布局建议

### 主机 PCB

1. **ESP8266 天线**: 保持天线区域净空，不要走线
2. **PAN3031 天线**: 使用弹簧天线或 PCB 天线，远离金属
3. **电源走线**: 加粗电源和地线 (≥20mil)
4. **去耦电容**: 每个芯片 VCC 就近放置 100nF 电容
5. **OLED 接口**: 放在 PCB 边缘，方便安装

### 从机 PCB

1. **大电流路径**: 继电器到接线端子的走线加宽 (≥50mil)
2. **ADC 走线**: 液位传感器走线远离高频信号
3. **天线区域**: PAN3031 天线保持净空
4. **散热**: 继电器和 LDO 下方放置散热过孔
5. **接线端子**: 使用螺钉端子，方便接线

---

## 防水设计

### 外壳选择

- **主机**: IP65 防水盒 (120×80×50mm)
- **从机**: IP67 防水盒 (150×100×60mm)
- **传感器**: IP68 防水等级

### 密封处理

1. 所有线缆入口使用防水接头 (PG7/PG9)
2. 外壳接缝处涂抹硅胶密封
3. PCB 喷涂三防漆 (防潮、防盐雾、防霉)
4. 天线使用防水馈线引出

---

## 调试接口

### 主机调试

```
USB 转 TTL 适配器
┌─────────┐
│ TX ─────┼── ESP8266 RX (GPIO3)
│ RX ─────┼── ESP8266 TX (GPIO1)
│ GND ────┼── GND
│         │  (不需要 VCC)
└─────────┘

波特率：115200
```

### 从机调试

```
USB 转 TTL 适配器 (3.3V)
┌─────────┐
│ TX ─────┼── STC32G RX (P3.0)
│ RX ─────┼── STC32G TX (P3.1)
│ GND ────┼── GND
│         │  (不需要 VCC)
└─────────┘

波特率：115200
```

---

**版本**: 1.0  
**更新日期**: 2026-02-28
