# 水塔监控系统 - 完整开发文档

## 系统架构

```
┌─────────────────────────────────────────────────────────┐
│                    手机 APP (Android)                    │
│                  WiFi / 4G / 互联网                      │
└────────────────────────────┬────────────────────────────┘
                             │ WiFi
                             ▼
┌─────────────────────────────────────────────────────────┐
│              ESP8266 主机 (Master)                       │
│  ┌──────────┐  ┌──────────┐  ┌──────────────────────┐  │
│  │ OLED 显示 │  │ Web 服务器│  │ 自动/手动控制逻辑    │  │
│  └──────────┘  └──────────┘  └──────────────────────┘  │
│              PAN3031 LoRa (433MHz)                      │
└────────────────────────────┬────────────────────────────┘
                             │ LoRa 1-3km
        ┌────────────────────┼────────────────────┐
        │                    │                    │
   ┌────┴────┐          ┌────┴────┐          ┌────┴────┐
   │ 从机 1   │          │ 从机 2   │          │ 从机 N   │
   │ STC8G1K08│          │ STC8G1K08│          │ STC8G1K08│
   │ 液位传感 │          │ 液位传感 │          │ 液位传感 │
   │ 水泵控制 │          │ 水泵控制 │          │ 水泵控制 │
   │ 缺水检测 │          │ 缺水检测 │          │ 缺水检测 │
   └─────────┘          └─────────┘          └─────────┘
```

## 硬件清单

### 主机 (ESP8266)

| 元件 | 型号 | 单价 | 数量 | 小计 |
|------|------|------|------|------|
| ESP8266 | NodeMCU | ¥25 | 1 | ¥25 |
| LoRa | PAN3031 | ¥35 | 1 | ¥35 |
| OLED | 0.96" I2C | ¥15 | 1 | ¥15 |
| 缺水传感器 | 光电液位 | ¥20 | 1 | ¥20 |
| PCB+ 外壳 | 定制 | ¥50 | 1 | ¥50 |
| **合计** | | | | **¥145** |

### 从机 (STC8G1K08)

| 元件 | 型号 | 单价 | 数量 | 小计 |
|------|------|------|------|------|
| MCU | STC8G1K08 | ¥8 | 1 | ¥8 |
| LoRa | PAN3031 | ¥35 | 1 | ¥35 |
| 液位传感器 | 4-20mA | ¥80 | 1 | ¥80 |
| 继电器 | 5V 单路 | ¥10 | 1 | ¥10 |
| 缺水传感器 | 光电液位 | ¥20 | 1 | ¥20 |
| 电源 | 5V DC-DC | ¥15 | 1 | ¥15 |
| PCB+ 外壳 | 定制 | ¥50 | 1 | ¥50 |
| **合计** | | | | **¥218** |

**示例配置 (1 主 4 从)**: ¥145 + (¥218 × 4) = **¥1,017**

对比商业方案 (¥5,000+)，**节省 80% 成本**

## 软件架构

### 主机 (ESP8266)

**功能**:
1. PAN3031 LoRa 通信管理
2. Web 服务器 (REST API)
3. 自动水位控制逻辑
4. 历史记录存储
5. OLED 显示
6. WiFi 连接

**关键代码**:
- `main.cpp`: 主程序
- `pan3031.cpp`: LoRa 驱动
- `water_system.h`: 数据结构

**API 接口**:
```
GET  /api/status      - 系统状态
GET  /api/towers      - 水塔列表
POST /api/pump        - 水泵控制
POST /api/mode        - 模式切换
GET  /api/history     - 历史记录
```

### 从机 (STC8G1K08)

**功能**:
1. 液位传感器读取 (ADC)
2. 缺水检测
3. 水泵继电器控制
4. PAN3031 通信
5. 超低功耗睡眠

**关键代码**:
- `main.c`: 主程序
- `pan3031.c`: LoRa 驱动
- `slave_config.h`: 配置

**功耗管理**:
- 工作电流：~5mA
- 睡眠电流：<10μA
- 发送间隔：5 秒
- 续航：2 年 (2000mAh 电池)

### Android APP

**功能**:
- 实时水位监控
- 水泵远程控制
- 历史曲线图
- 缺水报警
- 演示模式

**APK 位置**:
```
android_app/app/build/outputs/apk/debug/app-debug.apk
```

## 通信协议

### LoRa 帧格式

```
| 目标地址 (1B) | 源地址 (1B) | 命令 (1B) | 长度 (1B) | 数据 (N) |
```

### 命令字

| 命令 | 值 | 方向 | 说明 |
|------|-----|------|------|
| CMD_HEARTBEAT | 0x01 | 从→主 | 心跳 (含水位) |
| CMD_QUERY | 0x02 | 主→从 | 查询状态 |
| CMD_PUMP_CTRL | 0x10 | 主→从 | 水泵控制 |
| CMD_SET_AUTO | 0x20 | 主→从 | 自动模式 |
| CMD_SET_MANUAL | 0x21 | 主→从 | 手动模式 |
| CMD_ALARM | 0xFF | 从→主 | 报警 |

### 地址分配

- `0x00`: 主机
- `0x01` - `0xFE`: 从机
- `0xFF`: 广播

## 编译说明

### 主机 (ESP8266)

```bash
cd esp8266_master
platformio run --target upload
```

或 Arduino IDE:
1. 安装 ESP8266 开发板
2. 打开 `main.cpp`
3. 选择 NodeMCU 开发板
4. 编译上传

### 从机 (STC8G1K08)

```bash
cd slave_node_stc8g
make
```

输出:
- `output/water_slave_stc8g.hex`
- `output/water_slave_stc8g.bin`

烧录:
- 使用 STC-ISP 工具
- 或 `stcgal -P stc8g -p COM3 output/water_slave_stc8g.hex`

### Android APP

```bash
cd android_app
./gradlew assembleDebug
```

APK: `app/build/outputs/apk/debug/app-debug.apk`

## 配置说明

### WiFi 配置

编辑 `esp8266_master/src/main.cpp`:
```cpp
const char* WIFI_SSID = "YourWiFiSSID";
const char* WIFI_PASS = "YourWiFiPassword";
```

### 从机地址

编辑 `slave_node_stc8g/inc/slave_config.h`:
```cpp
#define NODE_ID  0x01  // 1-254
```

### 通信参数

```cpp
#define PAN3031_FREQ  434000000  // 434MHz
#define PAN3031_SF    7          // SF7
#define PAN3031_BW    125000     // 125kHz
#define PAN3031_PWR   20         // 20dBm
```

## 低功耗设计

### 从机功耗优化

1. **睡眠模式**: CPU 暂停，仅外部中断工作
2. **定时唤醒**: 每 5 秒唤醒一次
3. **快速处理**: 唤醒后 100ms 内完成
4. **PAN3031 睡眠**: 不通信时关闭

### 功耗计算

```
周期：5 秒
- 工作 100ms: 5mA × 0.1s = 0.5mAs
- 睡眠 4.9s: 0.01mA × 4.9s = 0.049mAs
- 平均：0.11mA

电池：2000mAh
续航：2000 / 0.11 ≈ 18181 小时 ≈ 2 年
```

## 自动控制逻辑

### 水位控制

```
水位 < 20%  → 开启水泵
水位 > 90%  → 关闭水泵
```

### 缺水保护

```
井水缺水 → 关闭所有水泵
井水恢复 → 自动恢复
```

### 过载保护

```
连续运行 30 分钟 → 强制停机 5 分钟
```

## 部署步骤

### 1. 硬件准备

- 焊接主机 PCB
- 焊接从机 PCB
- 安装传感器
- 防水处理

### 2. 软件烧录

- 主机烧录 ESP8266 固件
- 从机烧录 STC8G 固件
- 配置 WiFi 和地址

### 3. 现场安装

- 主机安装在控制室
- 从机安装在水塔旁
- 连接传感器和水泵
- 测试通信

### 4. 系统调试

- 检查各从机在线状态
- 测试水泵控制
- 验证缺水保护
- 配置手机 APP

## 故障排查

### 从机离线

1. 检查电源
2. 检查 PAN3031 天线
3. 检查地址配置
4. 测试通信距离

### 水位数据异常

1. 检查传感器接线
2. 校准 ADC
3. 检查传感器供电
4. 更换传感器

### 水泵不工作

1. 检查继电器
2. 检查水泵电源
3. 检查控制逻辑
4. 手动测试

## 后续优化

- [ ] 添加 EEPROM 配置保存
- [ ] OTA 远程升级
- [ ] 看门狗保护
- [ ] 太阳能供电
- [ ] 4G 远程通信
- [ ] MQTT 云端集成

## 技术栈

| 组件 | 技术 |
|------|------|
| 主机 MCU | ESP8266 (Arduino) |
| 从机 MCU | STC8G1K08 (SDCC) |
| LoRa | PAN3031 433MHz |
| 显示 | OLED I2C |
| APP | Android Kotlin |
| 通信协议 | 自定义 LoRa |
| Web | ESP8266WebServer |

## 开源协议

MIT License

---

**开发时间**: 2026 年 2 月  
**版本**: v2.0 (低功耗版)  
**作者**: Wlinuxhv
