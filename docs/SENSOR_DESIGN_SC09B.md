# SC09B 电容式水位传感器设计

## 系统概述

基于厦门晶尊微电子 SC09B 芯片的 9 通道电容式水位检测系统。

### 特点

- ✅ **9 通道检测**: 10%~90% 水位，分辨率 10%
- ✅ **水电隔离**: PE 管隔离，安全可靠
- ✅ **I2C 接口**: 简化布线，仅需 2 根信号线
- ✅ **低功耗**: 工作 0.65mA，睡眠 20μA
- ✅ **工业级**: 抗干扰强，适合户外环境

---

## 硬件设计

### 芯片选型：SC09B

| 参数 | 值 |
|------|-----|
| 通道数 | 9 |
| 工作电压 | 2.5V-6.5V |
| 工作电流 | 0.65mA@3V |
| 睡眠电流 | 20μA@3V |
| 接口 | 简易 I2C |
| 封装 | SOP16 |
| 单价 | ¥3-5 |

### 系统架构

```
┌─────────────────────────────────────────────────────┐
│                水塔                                   │
│                                                       │
│   ┌─────────────────────────────────────┐            │
│   │      PE 检测管 (细长，耐腐蚀)        │            │
│   │  ┌───────────────────────────────┐  │            │
│   │  │  电极 9 (90%) ────────────┐   │  │            │
│   │  │  电极 8 (80%) ────────────┤   │  │            │
│   │  │  电极 7 (70%) ────────────┤   │  │            │
│   │  │  电极 6 (60%) ────────────┤   │  │            │
│   │  │  电极 5 (50%) ────────────┤   │  │            │
│   │  │  电极 4 (40%) ────────────┤   │  │            │
│   │  │  电极 3 (30%) ────────────┤   │  │            │
│   │  │  电极 2 (20%) ────────────┤   │  │            │
│   │  │  电极 1 (10%) ────────────┤   │  │            │
│   │  │                           │   │  │            │
│   │  │  ┌─────────────┐          │   │  │            │
│   │  │  │   SC09B     │◄─────────┘   │  │            │
│   │  │  │   芯片      │               │  │            │
│   │  │  └──────┬──────┘               │  │            │
│   │  │         │ I2C + 电源            │  │            │
│   │  └─────────┼───────────────────────┘  │            │
│   │            │ 4 芯电缆                   │            │
│   └────────────┼───────────────────────────┘            │
│                │                                        │
│                ▼                                        │
│   ┌─────────────────────────────────────────┐          │
│   │  防水接线盒 (IP65)                       │          │
│   │  ┌──────────────┐                       │          │
│   │  │  STC8G1K08   │◄──── I2C ─────────────┤          │
│   │  │  从机 MCU    │                        │          │
│   │  └──────────────┘                       │          │
│   │         │                               │          │
│   │    PAN3031 LoRa                          │          │
│   └─────────────────────────────────────────┘          │
└─────────────────────────────────────────────────────┘
```

---

## PE 管传感器设计

### 材料选择

| 材料 | 规格 | 要求 |
|------|------|------|
| PE 管 | 四分管 (Φ25mm) | 耐晒、耐腐蚀、食品级 |
| 管壁厚 | 1.5-2mm | 平衡强度和电容耦合 |
| 电极 | 铜箔胶带 | 5cm × 2cm，导电好 |
| 灌封胶 | 环氧树脂 | 防水、绝缘 |
| 电缆 | 4 芯屏蔽线 | 0.3mm²，抗干扰 |

### 电极布置

```
PE 管内部电极布置 (单位：cm):

顶部 (螺旋接口)
    │
    ├─────────────────┐
    │                 │
    │    10cm         │ ← 电极 9 (90% 水位)
    │                 │
    ├─────────────────┤
    │                 │
    │    10cm         │ ← 电极 8 (80% 水位)
    │                 │
    ├─────────────────┤
    │                 │
    │    10cm         │ ← 电极 7 (70% 水位)
    │                 │
    ├─────────────────┤
    │                 │
    │    10cm         │ ← 电极 6 (60% 水位)
    │                 │
    ├─────────────────┤
    │                 │
    │    10cm         │ ← 电极 5 (50% 水位)
    │                 │
    ├─────────────────┤
    │                 │
    │    10cm         │ ← 电极 4 (40% 水位)
    │                 │
    ├─────────────────┤
    │                 │
    │    10cm         │ ← 电极 3 (30% 水位)
    │                 │
    ├─────────────────┤
    │                 │
    │    10cm         │ ← 电极 2 (20% 水位)
    │                 │
    ├─────────────────┤
    │                 │
    │    10cm         │ ← 电极 1 (10% 水位)
    │                 │
    ├─────────────────┤
    │                 │
    │    10cm         │ ← 底部 (热熔密封)
    │                 │
    └─────────────────┘

总长度：约 100cm (根据水塔高度定制)
电极间距：10cm
电极尺寸：5cm × 2cm (铜箔)
```

### 电极制作

1. **裁剪铜箔**:
   - 尺寸：5cm × 2cm
   - 数量：9 片

2. **焊接导线**:
   - 使用 0.3mm² 多股线
   - 长度：根据 PE 管长度
   - 颜色区分：不同通道用不同颜色

3. **固定电极**:
   - 使用防水胶贴附在 PE 管内壁
   - 确保电极平整，无气泡
   - 导线从顶部统一引出

4. **安装 SC09B**:
   - PCB 板固定在 PE 管底部
   - 灌封胶密封
   - 连接 9 个电极导线

---

## 电路设计

### SC09B 引脚定义 (SOP16)

```
        ┌───┴───┐
    VCC │1    16│ GND
    IN1 │2    15│ SCL
    IN2 │3    14│ SDA
    IN3 │4    13│ NC
    IN4 │5    12│ NC
    IN5 │6    11│ TEST
    IN6 │7    10│ INT
    IN7 │8     9│ IN8
        └───────┘

实际连接:
- IN1~IN9: 9 个水位电极
- VCC: 3.3V
- GND: 地
- SCL: I2C 时钟 (接 P3.0)
- SDA: I2C 数据 (接 P3.1)
- INT: 数据就绪中断 (可选，接 P3.2)
- TEST: 测试引脚 (悬空或接测试按钮)
```

### 与 STC8G1K08 连接

```
┌──────────────────┐           ┌─────────────────┐
│     SC09B        │           │   STC8G1K08     │
│                  │           │                 │
│ VCC ─────────────┼───────────┤ 3.3V            │
│ GND ─────────────┼───────────┤ GND             │
│ SCL ─────────────┼────┬─────┤ P3.0            │
│                  │    │     │                 │
│ SDA ─────────────┼────┼─────┤ P3.1            │
│                  │    │     │                 │
│ INT ─────────────┼────┴─────┤ P3.2 (可选)      │
│                  │           │                 │
│ IN1~IN9 ─────────┼── 到电极片                   │
└──────────────────┘           └─────────────────┘

上拉电阻:
- SCL: 4.7kΩ 到 VCC
- SDA: 4.7kΩ 到 VCC
```

### 原理图片段

```
         VCC (3.3V)
           │
      ┌────┴────┐
      │         │
     4.7k      4.7k
      │         │
      ├────┬────┤
      │    │    │
     SCL  SDA   │
      │    │    │
      └────┼────┘
           │
      ┌────┴────┐
      │  SC09B  │
      │         │
      │  I2C    │
      └────┬────┘
           │
      ┌────┴────┐
      │ STC8G   │
      │  MCU    │
      └─────────┘
```

---

## 软件驱动

### I2C 通信协议

SC09B 使用**简易 I2C 协议**:

```
写操作:
START → 0xA0 → STOP

读操作:
START → 0xA0 → STOP → START → 0xA1 → Read Data → STOP

数据格式:
- 低 8 位：通道 1-8 状态
- 高 1 位：通道 9 状态
```

### 驱动函数

```c
// 初始化
sc09b_init();

// 读取原始数据 (9 位)
uint16_t data = sc09b_read_water_level();

// 获取水位百分比 (0-100%)
uint8_t percent = sc09b_get_water_percent();

// 低功耗模式
sc09b_sleep();   // 20μA
sc09b_wakeup();  // 唤醒
```

### 水位计算

```c
// 通道定义
#define CH1  0x0001  // 10%
#define CH2  0x0002  // 20%
#define CH3  0x0004  // 30%
#define CH4  0x0008  // 40%
#define CH5  0x0010  // 50%
#define CH6  0x0020  // 60%
#define CH7  0x0040  // 70%
#define CH8  0x0080  // 80%
#define CH9  0x0100  // 90%

// 水位计算逻辑
if (data & CH9) level = 95;
else if (data & CH8) level = 85;
else if (data & CH7) level = 75;
// ... 以此类推
else level = 5;  // 无水
```

---

## 安装与调试

### 安装步骤

1. **PE 管安装**:
   - 水塔顶部开孔 (四分管螺纹)
   - 安装螺旋接口
   - 插入 PE 管，确保垂直

2. **电极连接**:
   - 9 个电极导线连接到 SC09B
   - 电源和 I2C 线连接到 STC8G
   - 检查接线无误

3. **密封处理**:
   - PE 管顶部灌封胶密封
   - 接线盒防水处理 (IP65)
   - 电缆入口密封

4. **测试**:
   - 浸水测试密封性
   - 测试各通道灵敏度
   - 校准水位百分比

### 调试方法

1. **灵敏度测试**:
   ```
   逐步加水，记录各通道触发点:
   - 10% 水位：电极 1 触发
   - 20% 水位：电极 1,2 触发
   - ...
   - 90% 水位：所有电极触发
   ```

2. **I2C 通信测试**:
   ```c
   // 读取芯片状态
   uint8_t status = sc09b_read_status();
   if (status != 0xFF) {
       // 通信正常
   }
   ```

3. **校准**:
   - 空塔：确认所有通道关闭
   - 满塔：确认所有通道打开
   - 中间水位：逐点校准

---

## 功耗优化

### SC09B 功耗

| 模式 | 电流 | 说明 |
|------|------|------|
| 工作 | 0.65mA | 正常检测 |
| 睡眠 | 20μA | 自动睡眠 |

### 系统功耗

| 组件 | 睡眠 | 工作 |
|------|------|------|
| STC8G | <5μA | ~5mA |
| SC09B | 20μA | 0.65mA |
| PAN3031 | <1μA | ~12mA |
| **总计** | **<30μA** | **~18mA** |

### 低功耗策略

1. **定时检测**: 每 5 秒检测一次
2. **自动睡眠**: SC09B 无检测时自动睡眠
3. **中断唤醒**: 数据就绪中断唤醒 MCU
4. **协同管理**: MCU 和传感器同时睡眠

---

## 成本分析

### 单塔传感器成本

| 材料 | 单价 | 数量 | 小计 |
|------|------|------|------|
| SC09B 芯片 | ¥4 | 1 | ¥4 |
| PE 管 (2 米) | ¥5/米 | 2 | ¥10 |
| 铜箔胶带 | ¥10 | 1 卷 | ¥10 |
| 4 芯电缆 | ¥3/米 | 2 米 | ¥6 |
| 接线盒 (IP65) | ¥15 | 1 | ¥15 |
| 灌封胶 | ¥15 | 1 支 | ¥15 |
| 螺旋接头 | ¥5 | 1 | ¥5 |
| PCB+ 辅料 | ¥10 | 1 | ¥10 |
| **合计** | | | **¥75** |

对比 4-20mA 变送器 (¥80+)，**成本相当但更可靠！**

---

## 优势对比

| 方案 | 成本 | 精度 | 可靠性 | 维护 | 寿命 |
|------|------|------|--------|------|------|
| **SC09B+PE 管** | ¥75 | 10% | 高 | 低 | 5 年 + |
| 4-20mA 变送器 | ¥80 | 连续 | 中 | 中 | 3 年 |
| 浮球开关 | ¥30 | 分段 | 低 | 高 | 2 年 |
| 超声波 | ¥150 | 连续 | 中 | 中 | 3 年 |

**优势**:
- ✅ 水电完全隔离，安全可靠
- ✅ 无机械部件，寿命长
- ✅ 耐腐蚀，适合户外
- ✅ 多通道检测，精度高
- ✅ 低功耗，电池供电

---

## 注意事项

### 1. PE 管壁厚

- **推荐**: 1.5-2mm
- 太厚：电容耦合弱，灵敏度低
- 太薄：强度不足，易损坏

### 2. 电极尺寸

- **推荐**: 5cm × 2cm
- 太大：响应慢
- 太小：灵敏度低

### 3. 防干扰

- 使用屏蔽电缆
- I2C 加上拉电阻 (4.7kΩ)
- 远离强电干扰源

### 4. 温度影响

- 电容值受温度影响
- 建议添加温度传感器 (如 DS18B20)
- 软件温度补偿

### 5. 定期维护

- 清洁 PE 管外壁 (防藻类)
- 检查密封性
- 校准水位检测

---

## 文件清单

- ✅ `slave_node_stc8g/src/sc09b.c` - SC09B 驱动
- ✅ `slave_node_stc8g/inc/sc09b.h` - 驱动头文件
- ✅ `slave_node_stc8g/src/main.c` - 主程序 (已集成)
- ✅ `docs/SENSOR_DESIGN_SC09B.md` - 本文档

---

**传感器设计完成！准备制作原型测试！** 🔧💧
