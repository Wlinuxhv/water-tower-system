# 水塔液位监控系统 - 系统设计文档

**版本**: v1.0  
**日期**: 2026-02-27  
**作者**: OpenClaw Agent

---

## 1. 项目概述

### 1.1 项目背景
某地区有多个分散的水塔需要监控水位，传统人工巡检效率低下，需要一套自动化监控系统实现：
- 远程实时监测各水塔水位
- 自动控制水泵抽水
- 缺水保护防止水泵损坏
- 手机 APP 远程查看和控制

### 1.2 系统目标
| 目标 | 描述 |
|------|------|
| 实时监控 | 各水塔水位数据实时上传 |
| 自动控制 | 水位低时自动开启水泵 |
| 远程管理 | 手机 APP 远程查看和控制 |
| 安全保护 | 井水缺水时自动停泵保护 |
| 一主多从 | 1 个主机管理最多 8 个从机节点 |

### 1.3 技术指标
| 参数 | 指标 |
|------|------|
| 通信距离 | 1-3 km (视距) |
| 水位精度 | ±5% |
| 响应时间 | < 5 秒 |
| 工作电压 | DC 12V/24V |
| 工作温度 | -20°C ~ +70°C |
| 防护等级 | IP65 (室外) |

---

## 2. 系统架构

### 2.1 整体架构
```
┌────────────────────────────────────────────────────────────────┐
│                        用户层 (User Layer)                      │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │              手机 APP (Android/iOS)                       │  │
│  │   • 实时水位显示    • 手动/自动切换    • 水泵控制        │  │
│  │   • 历史记录查询    • 报警通知         • 多水塔管理      │  │
│  └──────────────────────────────────────────────────────────┘  │
│                              ▲                                  │
│                              │ WiFi / 4G                        │
└──────────────────────────────┼──────────────────────────────────┘
                               │
┌──────────────────────────────┼──────────────────────────────────┐
│                      控制层 (Control Layer)                     │
│  ┌──────────────────────────┴──────────────────────────────┐  │
│  │              ESP8266 主控制器 (Master)                    │  │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────────┐  │  │
│  │  │  WiFi 模块   │  │  OLED 显示   │  │  PAN3031 无线   │  │  │
│  │  │  (2.4GHz)   │  │  (128x64)   │  │  (433MHz LoRa)  │  │  │
│  │  └─────────────┘  └─────────────┘  └─────────────────┘  │  │
│  │  • Web 服务器    • 本地数据显示    • 从机通信管理        │  │
│  │  • API 接口      • 状态指示        • 协议转换            │  │
│  └───────────────────────────────────────────────────────────┘  │
│                              ▲                                  │
│                              │ LoRa 433MHz                      │
└──────────────────────────────┼──────────────────────────────────┘
                               │
        ┌──────────────────────┼──────────────────────┐
        │                      │                      │
   ┌────┴────┐            ┌────┴────┐           ┌────┴────┐
   │ 从机节点 1│            │ 从机节点 2│           │ 从机节点 N│
   │ 水塔 1    │            │ 水塔 2    │           │ 水塔 N    │
   │ ID: 0x01 │            │ ID: 0x02 │           │ ID: 0xFF │
   └─────────┘            └─────────┘           └─────────┘
```

### 2.2 硬件架构
```
┌─────────────────────────────────────────────────────────────┐
│                    主机 (ESP8266)                            │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐   │
│  │ ESP8266  │  │  OLED    │  │ PAN3031  │  │ 电源模块 │   │
│  │   WiFi   │──│  I2C     │──│   SPI    │──│ 12V/5V   │   │
│  └────┬─────┘  └──────────┘  └────┬─────┘  └──────────┘   │
│       │                           │                         │
│       └───────────┬───────────────┘                         │
│                   │                                         │
│            ┌──────┴──────┐                                  │
│            │  缺水检测   │                                  │
│            │  (GPIO)     │                                  │
│            └─────────────┘                                  │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│                   从机 (STC32G)                              │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐   │
│  │  STC32G  │  │ PAN3031  │  │ 液位传感 │  │ 继电器   │   │
│  │   MCU    │──│   SPI    │──│  (ADC)   │──│ 水泵控制 │   │
│  └────┬─────┘  └────┬─────┘  └──────────┘  └────┬─────┘   │
│       │            │                             │         │
│       │       ┌────┴─────┐                  ┌────┴─────┐   │
│       │       │ 缺水检测 │                  │  水泵    │   │
│       │       │ (GPIO)   │                  │  (220V)  │   │
│       │       └──────────┘                  └──────────┘   │
│       │                                                     │
│       └────────── 拨码开关 (地址设置) ──────────────────┘   │
└─────────────────────────────────────────────────────────────┘
```

### 2.3 软件架构
```
┌────────────────────────────────────────────────────────────┐
│                      应用层 (Application)                   │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐     │
│  │  Android APP │  │  Web 界面    │  │  OLED 显示    │     │
│  └──────────────┘  └──────────────┘  └──────────────┘     │
└────────────────────────────────────────────────────────────┘
                            │
┌────────────────────────────────────────────────────────────┐
│                      服务层 (Service)                       │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐     │
│  │  HTTP Server │  │  数据处理    │  │  报警管理    │     │
│  │  (ESP8266)   │  │  逻辑运算    │  │  历史记录    │     │
│  └──────────────┘  └──────────────┘  └──────────────┘     │
└────────────────────────────────────────────────────────────┘
                            │
┌────────────────────────────────────────────────────────────┐
│                      通信层 (Communication)                 │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐     │
│  │  WiFi 通信   │  │ LoRa 通信    │  │  I2C 通信    │     │
│  │  (TCP/IP)    │  │  (PAN3031)   │  │  (OLED)      │     │
│  └──────────────┘  └──────────────┘  └──────────────┘     │
└────────────────────────────────────────────────────────────┘
                            │
┌────────────────────────────────────────────────────────────┐
│                      驱动层 (Driver)                        │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐     │
│  │  GPIO 驱动   │  │  ADC 驱动    │  │  SPI 驱动    │     │
│  │  (水泵/传感) │  │  (液位)      │  │  (PAN3031)   │     │
│  └──────────────┘  └──────────────┘  └──────────────┘     │
└────────────────────────────────────────────────────────────┘
```

---

## 3. 硬件设计

### 3.1 主机硬件 (ESP8266)

#### 3.1.1 核心组件
| 组件 | 型号 | 数量 | 说明 |
|------|------|------|------|
| MCU | ESP8266 NodeMCU | 1 | WiFi 主控 |
| 无线 | PAN3031 | 1 | 433MHz LoRa |
| 显示 | OLED 0.96" | 1 | I2C 128x64 |
| 传感器 | 浮球开关 | 1 | 井水缺水检测 |
| 电源 | 12V 转 5V | 1 | DC-DC 降压 |

#### 3.1.2 引脚分配
| ESP8266 引脚 | 功能 | 连接设备 |
|-------------|------|----------|
| D1 (GPIO5) | I2C SDA | OLED |
| D2 (GPIO4) | I2C SCL | OLED |
| D3 (GPIO0) | I2C RST | OLED 复位 |
| D5 (GPIO14) | SPI CS | PAN3031 |
| D6 (GPIO12) | SPI MISO | PAN3031 |
| D7 (GPIO13) | SPI MOSI | PAN3031 |
| D8 (GPIO15) | SPI SCK | PAN3031 |
| D4 (GPIO2) | IRQ | PAN3031 中断 |
| D0 (GPIO16) | INPUT | 缺水检测 |
| 3V3 | VCC | OLED/PAN3031 |
| GND | GND | 共地 |

#### 3.1.3 电源设计
```
DC 12V 输入
    │
    ├───┬───────────────┐
    │   │               │
┌───┴───┴───┐   ┌───────┴───────┐
│ DC-DC 5V  │   │ DC-DC 3.3V    │
│ 降压模块  │   │ LDO 稳压      │
└─────┬─────┘   └───────┬───────┘
      │                 │
      ├──── ESP8266     ├──── OLED
      ├──── PAN3031     └──── 传感器
      └──── 继电器驱动
```

### 3.2 从机硬件 (STC32G)

#### 3.2.1 核心组件
| 组件 | 型号 | 数量 | 说明 |
|------|------|------|------|
| MCU | STC32G12K128 | 1 | 8051 内核 |
| 无线 | PAN3031 | 1 | 433MHz LoRa |
| ADC | 内置 12 位 | 1 | 液位传感器 |
| 继电器 | 5V 单路 | 1 | 水泵控制 |
| 传感器 | 液位变送器 | 1 | 4-20mA/0-10V |
| 传感器 | 浮球开关 | 1 | 缺水检测 |
| 拨码 | 8 位拨码 | 1 | 地址设置 |

#### 3.2.2 引脚分配
| STC32G 引脚 | 功能 | 连接设备 |
|------------|------|----------|
| P2.0 | SPI SCK | PAN3031 |
| P2.1 | SPI MISO | PAN3031 |
| P2.2 | SPI MOSI | PAN3031 |
| P2.3 | SPI CS | PAN3031 |
| P3.2 | IRQ | PAN3031 中断 |
| P1.0 | ADC IN | 液位传感器 |
| P3.3 | OUTPUT | 水泵继电器 |
| P3.4 | INPUT | 缺水检测 |
| P4.0-P4.7 | INPUT | 拨码开关 (地址) |

#### 3.2.3 继电器驱动电路
```
STC32G P3.3
    │
    └───[1kΩ]───┬─── 三极管 S8050 基极
                │
三极管发射极 ───┴─── GND
三极管集电极 ───┬─── 继电器线圈 ─── 12V
                │
                └─── 续流二极管 1N4148
```

### 3.3 传感器选型

#### 3.3.1 液位传感器
| 类型 | 量程 | 输出 | 精度 | 价格 |
|------|------|------|------|------|
| 投入式 | 0-5m | 4-20mA | ±0.5% | ¥80 |
| 超声波 | 0-10m | RS485 | ±0.3% | ¥200 |
| 浮球式 | 0-3m | 开关量 | ±5% | ¥20 |

**推荐**: 投入式液位变送器 (性价比高，精度够用)

#### 3.3.2 缺水检测
| 类型 | 原理 | 优点 | 缺点 |
|------|------|------|------|
| 浮球开关 | 机械浮力 | 简单可靠 | 有机械磨损 |
| 电极式 | 水电导 | 无机械 | 易腐蚀 |
| 光电式 | 光学折射 | 长寿命 | 成本高 |

**推荐**: 不锈钢浮球开关 (耐用可靠)

---

## 4. 软件设计

### 4.1 通信协议

#### 4.1.1 物理层
- **调制方式**: LoRa (扩频)
- **频率**: 433MHz (ISM 频段)
- **带宽**: 125kHz
- **扩频因子**: SF7
- **发射功率**: 20dBm
- **接收灵敏度**: -124dBm

#### 4.1.2 数据链路层
```
帧格式:
┌────────┬────────┬────────┬────────┬────────┬────────┬────────┬────────┐
│ 前导码 │ 同步字 │ 目标地址│ 源地址 │ 命令字 │ 数据长度│  数据  │  CRC   │
│  8B    │  4B    │  1B    │  1B    │  1B    │  1B    │  N B   │  2B    │
└────────┴────────┴────────┴────────┴────────┴────────┴────────┴────────┘
```

#### 4.1.3 应用层命令
| 命令字 | 名称 | 方向 | 说明 |
|--------|------|------|------|
| 0x01 | JOIN_REQ | 从→主 | 请求加入网络 |
| 0x02 | JOIN_ACK | 主→从 | 确认加入 |
| 0x03 | HEARTBEAT | 从→主 | 心跳包 (水位数据) |
| 0x10 | PUMP_CTRL | 主→从 | 水泵控制 |
| 0x11 | QUERY_STATUS | 主→从 | 查询状态 |
| 0x12 | SET_ADDR | 主→从 | 设置地址 |
| 0xFF | BROADCAST | 双向 | 广播 |

#### 4.1.4 地址分配
| 地址范围 | 用途 | 说明 |
|----------|------|------|
| 0x00 | 主机 | 固定为主机地址 |
| 0x01-0xFE | 从机 | 最多 254 个从机 |
| 0xFF | 广播 | 群发命令 |

### 4.2 主机软件流程

#### 4.2.1 主程序流程
```
开始
  │
  ├─→ 初始化硬件 (GPIO/SPI/I2C/UART)
  │
  ├─→ 连接 WiFi
  │     │
  │     ├─ 成功 → 启动 Web 服务器
  │     └─ 失败 → 重试 (最多 3 次)
  │
  ├─→ 初始化 PAN3031
  │
  ├─→ 进入主循环
  │     │
  │     ├─ 处理 WiFi 请求
  │     ├─ 接收从机数据
  │     ├─ 更新 OLED 显示
  │     ├─ 检查缺水保护
  │     └─ 自动模式控制水泵
  │
  └─→ 循环执行
```

#### 4.2.2 网络管理
```c
// 从机状态管理
typedef struct {
    uint8_t id;           // 从机 ID
    uint8_t water_level;  // 水位 (%)
    bool pump_on;         // 水泵状态
    bool online;          // 在线状态
    uint32_t last_seen;   // 最后通信时间
} slave_node_t;

// 心跳超时检测 (30 秒)
if (millis() - slave[i].last_seen > 30000) {
    slave[i].online = false;
    alarm_offline(slave[i].id);
}
```

### 4.3 从机软件流程

#### 4.3.1 主程序流程
```
开始
  │
  ├─→ 读取拨码开关地址
  │
  ├─→ 初始化硬件
  │
  ├─→ 发送入网请求 (JOIN_REQ)
  │     │
  │     ├─ 收到 ACK → 进入正常工作
  │     └─ 超时 → 重试 (最多 5 次)
  │
  ├─→ 进入主循环
  │     │
  │     ├─ 读取水位 (ADC)
  │     ├─ 检查缺水
  │     ├─ 接收主机命令
  │     ├─ 执行水泵控制
  │     └─ 发送心跳包 (5 秒)
  │
  └─→ 循环执行
```

#### 4.3.2 地址设置
```
拨码开关 (8 位) → 二进制地址 → 0x01-0xFE
例如：00000001 = 0x01 (1 号从机)
      00000010 = 0x02 (2 号从机)
      11111110 = 0xFE (254 号从机)
```

### 4.4 Android APP 设计

#### 4.4.1 功能模块
```
┌─────────────────────────────────────────────────────┐
│                    水塔监控 APP                      │
├─────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐ │
│  │   首页      │  │   监控      │  │   设置      │ │
│  │             │  │             │  │             │ │
│  │ • 总览      │  │ • 水位曲线  │  │ • WiFi 配置  │ │
│  │ • 快速控制  │  │ • 历史记录  │  │ • 报警设置  │ │
│  │ • 报警信息  │  │ • 导出报表  │  │ • 关于      │ │
│  └─────────────┘  └─────────────┘  └─────────────┘ │
└─────────────────────────────────────────────────────┘
```

#### 4.4.2 界面设计
```
┌─────────────────────────────────┐
│  水塔监控系统          [设置]   │
├─────────────────────────────────┤
│  模式：●自动  ○手动            │
├─────────────────────────────────┤
│  水塔 1                         │
│  ████████░░ 80%        [泵✓]   │
│  最后更新：10 秒前              │
├─────────────────────────────────┤
│  水塔 2                         │
│  ████░░░░░░ 40%        [泵✗]   │
│  最后更新：5 秒前               │
├─────────────────────────────────┤
│  水塔 3 (离线)                  │
│  ░░░░░░░░░░ --%        [泵？]  │
│  最后更新：5 分钟前             │
└─────────────────────────────────┘
```

#### 4.4.3 API 接口
| 接口 | 方法 | 说明 |
|------|------|------|
| `/api/status` | GET | 获取系统状态 |
| `/api/towers` | GET | 获取所有水塔数据 |
| `/api/pump` | POST | 控制水泵 |
| `/api/mode` | POST | 切换模式 |
| `/api/history` | GET | 历史记录 |

---

## 5. 安全保护

### 5.1 缺水保护
```
井水缺水检测 → 信号输入 ESP8266
    │
    ├─ 缺水 → 立即关闭所有水泵
    │        → 发送报警通知
    │        → OLED 显示"缺水!"
    │
    └─ 恢复 → 延时 30 秒后自动恢复
```

### 5.2 过载保护
- 水泵连续运行超过 30 分钟 → 强制停机 10 分钟
- 水泵启动失败超过 3 次 → 报警并停机

### 5.3 通信保护
- 从机 30 秒无心跳 → 标记离线
- 主机 60 秒无响应 → 从机保持当前状态
- 数据 CRC 校验失败 → 丢弃并重传

### 5.4 电气保护
- 继电器反向并联续流二极管
- 电源输入加保险丝 (2A)
- 信号线加 TVS 防浪涌
- PCB 敷铜接地

---

## 6. 安装部署

### 6.1 主机安装
```
位置：控制室/值班室
供电：DC 12V/2A
安装：导轨安装或壁挂
接线:
  - 电源输入
  - 缺水传感器
  - 天线 (PAN3031)
```

### 6.2 从机安装
```
位置：各水塔现场
供电：DC 12V/2A (取自水泵控制箱)
防护：IP65 防水箱
接线:
  - 电源输入
  - 液位传感器 (投入式)
  - 缺水检测 (浮球开关)
  - 水泵继电器输出
  - 天线 (PAN3031)
```

### 6.3 天线布置
- 主机：室外吸顶天线 (增益 5dBi)
- 从机：玻璃钢天线 (增益 3dBi)
- 高度：尽量高，避开金属遮挡
- 距离：离墙>50cm

---

## 7. 调试与测试

### 7.1 单机测试
1. 从机单独上电 → 检查 PAN3031 通信
2. 模拟水位变化 → 检查 ADC 读数
3. 手动控制水泵 → 检查继电器动作

### 7.2 组网测试
1. 主机上电 → 检查 WiFi 连接
2. 从机依次上电 → 检查自动入网
3. 查看 OLED → 确认数据显示
4. APP 连接 → 检查远程控制

### 7.3 保护测试
1. 模拟缺水 → 检查停泵保护
2. 断开天线 → 检查离线报警
3. 短路水泵 → 检查过载保护

---

## 8. 物料清单 (BOM)

### 8.1 主机 BOM
| 序号 | 名称 | 型号 | 数量 | 单价 | 小计 |
|------|------|------|------|------|------|
| 1 | ESP8266 开发板 | NodeMCU | 1 | ¥25 | ¥25 |
| 2 | LoRa 模块 | PAN3031 | 1 | ¥45 | ¥45 |
| 3 | OLED 显示屏 | 0.96" I2C | 1 | ¥15 | ¥15 |
| 4 | DC-DC 模块 | 12V 转 5V | 1 | ¥8 | ¥8 |
| 5 | 缺水传感器 | 浮球开关 | 1 | ¥20 | ¥20 |
| 6 | 天线 | 433MHz 5dBi | 1 | ¥15 | ¥15 |
| 7 | PCB 板 | 定制 | 1 | ¥30 | ¥30 |
| 8 | 外壳 | ABS 防水 | 1 | ¥25 | ¥25 |
| **合计** | | | | | **¥183** |

### 8.2 从机 BOM (单节点)
| 序号 | 名称 | 型号 | 数量 | 单价 | 小计 |
|------|------|------|------|------|------|
| 1 | STC32G 开发板 | STC32G12K128 | 1 | ¥35 | ¥35 |
| 2 | LoRa 模块 | PAN3031 | 1 | ¥45 | ¥45 |
| 3 | 液位传感器 | 投入式 0-5m | 1 | ¥80 | ¥80 |
| 4 | 缺水检测 | 浮球开关 | 1 | ¥20 | ¥20 |
| 5 | 继电器模块 | 5V 单路 | 1 | ¥10 | ¥10 |
| 6 | 拨码开关 | 8 位 | 1 | ¥5 | ¥5 |
| 7 | 天线 | 433MHz 3dBi | 1 | ¥10 | ¥10 |
| 8 | PCB 板 | 定制 | 1 | ¥30 | ¥30 |
| 9 | 外壳 | IP65 防水 | 1 | ¥35 | ¥35 |
| **合计** | | | | | **¥270** |

### 8.3 系统总价 (1 主 +4 从)
| 项目 | 数量 | 单价 | 小计 |
|------|------|------|------|
| 主机 | 1 | ¥183 | ¥183 |
| 从机 | 4 | ¥270 | ¥1080 |
| 安装辅材 | 1 | ¥200 | ¥200 |
| **总计** | | | **¥1463** |

---

## 9. 开发计划

| 阶段 | 时间 | 任务 | 交付物 |
|------|------|------|--------|
| 第一阶段 | 1 周 | 硬件设计 | 原理图/PCB |
| 第二阶段 | 1 周 | 嵌入式开发 | 主机/从机固件 |
| 第三阶段 | 1 周 | Android APP | APK 安装包 |
| 第四阶段 | 1 周 | 系统联调 | 测试报告 |
| 第五阶段 | 1 周 | 现场部署 | 竣工文档 |

**总工期**: 5 周

---

## 10. 风险评估

| 风险 | 概率 | 影响 | 应对措施 |
|------|------|------|----------|
| 通信距离不足 | 中 | 高 | 增加中继节点/提高天线高度 |
| 液位传感器故障 | 低 | 中 | 定期校准/备用传感器 |
| WiFi 不稳定 | 中 | 中 | 增加信号放大器 |
| 水泵过载 | 低 | 高 | 加装热继电器保护 |
| 雷击损坏 | 低 | 高 | 加装防雷器/接地 |

---

## 11. 附录

### 11.1 参考资料
- PAN3031 数据手册
- ESP8266 技术文档
- STC32G 用户手册
- LoRa 通信协议规范

### 11.2 版本历史
| 版本 | 日期 | 作者 | 变更说明 |
|------|------|------|----------|
| v1.0 | 2026-02-27 | OpenClaw | 初始版本 |

---

**文档结束**
