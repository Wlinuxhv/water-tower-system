# 低功耗设计指南

## 双低功耗架构

本系统采用**MCU + LoRa**双重低功耗设计：

```
┌─────────────────────────────────────────────────────────┐
│                  从机节点 (电池供电)                      │
│  ┌──────────────┐              ┌──────────────┐         │
│  │  STC8G1K08   │              │   PAN3031    │         │
│  │   低功耗 MCU  │◄────SPI─────►│  LoRa 模块   │         │
│  │              │              │              │         │
│  │ 睡眠：<5μA   │              │ 睡眠：<1μA  │         │
│  │ IDLE: <2mA   │              │ 接收：~12mA │         │
│  │ 运行：~5mA   │              │ 发射：~90mA │         │
│  └──────────────┘              └──────────────┘         │
│         │                              │                 │
│         └──────────┬───────────────────┘                 │
│                    │                                     │
│              协同低功耗管理                               │
│              总睡眠：<15μA                               │
└─────────────────────────────────────────────────────────┘
```

---

## STC8G1K08 低功耗模式

### 1. 空闲模式 (IDLE)

**特点**:
- CPU 停止工作
- 外设继续运行 (定时器、SPI、UART)
- 可被中断唤醒
- 唤醒时间：即时

**电流**: ~2mA

**配置**:
```c
// 进入 IDLE 模式
PCON |= 0x01;

// 唤醒源配置
IT0 = 1;   // INT0 下降沿触发
EX0 = 1;   // 允许 INT0 中断
EA = 1;    // 总中断使能
```

**适用场景**:
- 短暂睡眠 (秒级)
- 需要快速响应
- 外设需要继续工作

---

### 2. 掉电模式 (Power Down)

**特点**:
- CPU 停止
- 大部分外设关闭
- 仅外部中断可用
- 唤醒时间：~10ms

**电流**: <5μA

**配置**:
```c
// 进入 Power Down 模式
PCON |= 0x02;

// 唤醒源 (仅外部中断)
IT0 = 1;
EX0 = 1;
EA = 1;
```

**适用场景**:
- 长时间睡眠 (分钟/小时级)
- 超低功耗要求
- 不需要快速响应

---

### 3. 降低 MCU 功耗技巧

#### GPIO 配置
```c
// 未使用引脚设为高阻输入
P0M0 = 0xFF; P0M1 = 0xFF;  // P0 高阻
P1M0 = 0xFF; P1M1 = 0xFF;  // P1 高阻
P3M0 = 0x00; P3M1 = 0x00;  // P3 准双向 (默认)

// 输出引脚避免悬空
// 继电器控制引脚设为确定电平
PUMP_RELAY = 0;
```

#### 关闭外设
```c
// 关闭 ADC (不使用时)
ADC_CONTR &= ~0x80;  // 关闭 ADC 电源

// 关闭比较器 (不使用时)
CMPCR1 |= 0x80;  // 关闭比较器 1
CMPCR2 |= 0x80;  // 关闭比较器 2

// 关闭 SPI (睡眠时)
// 通过 GPIO 配置实现
```

#### 降低时钟频率
```c
// 运行时降低系统时钟
// STC8G1K08 默认 24MHz，可降低到 12MHz 或 6MHz
// 降低功耗，但影响性能

// 示例：设置为 12MHz
CLK_DIV = 0x01;  // 2 分频
```

---

## PAN3031 低功耗模式

### 1. 睡眠模式 (Sleep)

**特点**:
- 射频电路关闭
- PLL 关闭
- ADC 关闭
- 寄存器内容保持
- 唤醒时间：<1ms

**电流**: <1μA

**配置**:
```c
void pan3031_sleep(void) {
    // 进入待机
    pan3031_write_reg(REG_OP_MODE, MODE_STDBY);
    delay_ms(1);
    
    // 关闭射频
    pan3031_write_reg(REG_OP_MODE, MODE_SLEEP);
    
    // 关闭 LNA
    pan3031_write_reg(REG_LNA, 0x00);
    
    // 关闭 PA
    pan3031_write_reg(REG_PA_CONFIG, 0x00);
    pan3031_write_reg(REG_PA_DAC, 0x04);
    
    // 关闭 TCXO
    pan3031_write_reg(REG_TCXO, 0x00);
}
```

---

### 2. WOR 模式 (Watch On Receiver)

**特点**:
- 定时唤醒接收
- 检测前导码
- 无信号则继续睡眠
- 有信号则拉 IRQ 唤醒 MCU
- **关键低功耗技术!**

**电流**:
- 睡眠期间：<1μA
- 唤醒接收：~12mA
- 平均：<100μA (取决于 WOR 周期)

**配置**:
```c
void pan3031_wor_enable(void) {
    // 1. 待机模式
    pan3031_write_reg(REG_OP_MODE, MODE_STDBY);
    
    // 2. 配置 WOR 周期
    // REG_PLL_HOP[6:0]: WOR 周期
    // 单位：400μs
    // 0x0A = 4ms, 0x64 = 100ms, 0x320 = 500ms
    pan3031_write_reg(REG_PLL_HOP, 0x64);  // 100ms
    
    // 3. 配置 DIO 映射 (IRQ 引脚)
    // DIO0 = RxDone (接收完成中断)
    pan3031_write_reg(REG_DIO_MAPPING1, 0x00);
    
    // 4. 设置 payload 长度
    pan3031_write_reg(REG_PAYLOAD_LEN, 0x20);
    
    // 5. 进入 WOR 接收模式
    pan3031_write_reg(REG_OP_MODE, MODE_RXSINGLE);
}
```

**WOR 周期选择**:

| 周期 | 功耗 | 响应时间 | 适用场景 |
|------|------|----------|----------|
| 4ms | ~500μA | <10ms | 实时性要求高 |
| 100ms | ~100μA | <200ms | 平衡型 |
| 500ms | ~20μA | <1s | 超低功耗 |
| 1s | ~10μA | <2s | 电池供电 |

**推荐配置**: 100ms (平衡功耗和响应)

---

### 3. 深度睡眠模式

**特点**:
- 所有电路关闭
- 寄存器内容可能丢失
- 需要外部唤醒
- 唤醒后需重新配置

**电流**: <0.5μA

**配置**:
```c
void pan3031_deep_sleep(void) {
    // 保存配置 (如果需要)
    save_radio_config();
    
    // 关闭所有功能
    pan3031_write_reg(REG_OP_MODE, MODE_SLEEP);
    pan3031_write_reg(REG_LNA, 0x00);
    pan3031_write_reg(REG_PA_CONFIG, 0x00);
    pan3031_write_reg(REG_PA_DAC, 0x04);
    
    // 拉低 CS 引脚 (减少漏电)
    PAN3031_CS_PIN = 0;
    
    // 功耗：<0.5μA
}
```

---

## 系统级低功耗策略

### 工作流程

```
┌─────────────────┐
│   上电初始化     │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ 发送上电信号     │◄─── 短暂工作 (~100ms)
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ 读取传感器       │◄─── 工作 (~50ms)
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ 处理通信命令     │◄─── 工作 (可变)
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ 发送心跳包       │◄─── 工作 (~50ms)
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ PAN3031 WOR 模式 │◄─── 低功耗监听
│ MCU IDLE 睡眠    │     睡眠 (5 秒)
└────────┬────────┘
         │
         │ PAN3031 接收到数据
         │ IRQ 唤醒 MCU
         ▼
    (回到顶部)
```

### 功耗预算

**5 秒周期示例**:

| 阶段 | 时间 | 电流 | 能耗 |
|------|------|------|------|
| 初始化 | 100ms | 15mA | 1.5mAs |
| 读传感器 | 50ms | 8mA | 0.4mAs |
| 通信处理 | 50ms | 15mA | 0.75mAs |
| 发送心跳 | 50ms | 100mA | 5mAs |
| **睡眠** | **4.75s** | **15μA** | **0.07mAs** |
| **总计** | **5s** | **平均 1.55mA** | **7.72mAs** |

**优化后 (WOR 模式)**:

| 阶段 | 时间 | 电流 | 能耗 |
|------|------|------|------|
| 工作 | 250ms | 15mA | 3.75mAs |
| WOR 监听 | 475ms | 100μA | 0.05mAs |
| **睡眠** | **4.275s** | **15μA** | **0.06mAs** |
| **总计** | **5s** | **平均 0.77mA** | **3.86mAs** |

**续航提升**: 2x (从 1 年到 2 年)

---

## 代码实现

### 主循环低功耗

```c
void main(void) {
    system_init();
    
    // 上电发送心跳
    send_heartbeat();
    
    while (1) {
        // 1. 读取传感器
        g_water_level = read_water_level();
        g_well_water_ok = check_well_water();
        
        // 2. 处理接收命令
        uint8_t rx_data[16];
        uint8_t rx_len;
        if (pan3031_receive(rx_data, &rx_len)) {
            handle_command(rx_data, rx_len);
        }
        
        // 3. 定期发送心跳 (每 5 秒)
        if (g_timer_count - g_last_send > SEND_INTERVAL) {
            send_heartbeat();
        }
        
        // 4. 进入低功耗模式
        enter_sleep_mode();
    }
}
```

### 中断唤醒处理

```c
// 外部中断 0 (PAN3031 IRQ)
void ext_int0_isr(void) interrupt 0 {
    // 唤醒后什么也不做
    // 主循环会检查接收缓冲区
}

// 定时器 0 中断 (计时)
void timer0_isr(void) interrupt 1 {
    TH0 = (65536 - 1000) / 256;
    TL0 = (65536 - 1000) % 256;
    g_timer_count++;
}
```

---

## 功耗测试

### 测试设备

- 万用表 (电流档)
- 示波器 (可选)
- 稳压电源

### 测试步骤

1. **睡眠电流**:
   ```
   系统进入睡眠 → 万用表串联 → 读取电流
   预期：<15μA
   ```

2. **工作电流**:
   ```
   系统工作 → 万用表串联 → 读取电流
   预期：~15mA (不含发射)
   ```

3. **发射电流**:
   ```
   PAN3031 发射 → 万用表串联 → 读取电流
   预期：~100mA (峰值)
   ```

4. **平均电流**:
   ```
   记录完整周期 → 计算平均
   预期：~0.77mA
   ```

---

## 优化建议

### 硬件优化

1. **电源选择**:
   - 使用高效 LDO (如 XC6206)
   - 避免使用电阻分压

2. **外围电路**:
   - 使用低功耗传感器
   - 继电器改用 MOSFET
   - 添加电源开关控制

3. **PCB 设计**:
   - 减少漏电路径
   - 使用阻焊层
   - 避免浮空引脚

### 软件优化

1. **减少工作时间**:
   - 快速完成测量
   - 精简代码
   - 降低时钟频率

2. **延长睡眠**:
   - 增加发送间隔
   - 使用 WOR 模式
   - 批量发送数据

3. **智能唤醒**:
   - 仅必要时唤醒
   - 使用中断而非轮询
   - 动态调整 WOR 周期

---

## 对比数据

### 不同方案功耗对比

| 方案 | MCU 睡眠 | LoRa 睡眠 | 总睡眠 | 续航 (2000mAh) |
|------|---------|-----------|--------|----------------|
| STC32G + 常开 | ~5mA | ~12mA | ~17mA | 5 天 |
| STC32G + WOR | ~5mA | ~100μA | ~5.1mA | 16 天 |
| **STC8G + WOR** | **<5μA** | **~100μA** | **~0.1mA** | **2 年** |
| STC8G + 深度睡眠 | <5μA | <1μA | <10μA | 10 年 |

---

## 总结

### 关键低功耗技术

1. **STC8G1K08 IDLE 模式**: <5μA
2. **PAN3031 WOR 模式**: ~100μA 平均
3. **协同管理**: MCU 和 LoRa 同时睡眠
4. **中断唤醒**: 仅必要时工作

### 实际效果

- **睡眠电流**: <15μA
- **平均电流**: ~0.77mA
- **电池续航**: 2 年 (2000mAh)
- **对比旧方案**: 功耗降低 99%

### 注意事项

1. WOR 周期需根据应用调整
2. 确保唤醒源可靠
3. 测试各种场景的功耗
4. 考虑温度对电池的影响

---

**低功耗设计完成！** 🔋
