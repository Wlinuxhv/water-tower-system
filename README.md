# 🌊 水塔监控系统 (Water Tower Monitoring System)

基于 ESP8266 + STC32G + LoRa 433MHz 的一主多从智能水塔监控系统

[![Android CI](https://github.com/Wlinuxhv/water-tower-system/actions/workflows/android-ci.yml/badge.svg)](https://github.com/Wlinuxhv/water-tower-system/actions/workflows/android-ci.yml)

## 📋 系统特点

- **一主多从架构**: 1 个 ESP8266 主机管理最多 254 个从机节点
- **远距离通信**: LoRa 433MHz，通信距离 1-3km
- **自动组网**: 从机上电自动入网，无需手动配置
- **双重保护**: 主机 + 从机缺水检测，防止水泵烧毁
- **本地 + 远程显示**: OLED 实时显示 + Android APP 远程监控
- **自动/手动双模式**: 智能自动控制 + 手机远程手动控制

## 🏗️ 系统架构

```
┌─────────────────────────────────────────────────────────────┐
│                      手机 APP (Android)                      │
│                    WiFi / 4G 连接                            │
└────────────────────────────┬────────────────────────────────┘
                             │ WiFi
                             ▼
┌─────────────────────────────────────────────────────────────┐
│                  ESP8266 主控 (Master)                       │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐  │
│  │  OLED 显示   │  │  水位数据   │  │  自动/手动控制逻辑  │  │
│  └─────────────┘  └─────────────┘  └─────────────────────┘  │
│                    PAN3031 (433MHz LoRa)                     │
└────────────────────────────┬────────────────────────────────┘
                             │
        ┌────────────────────┼────────────────────┐
        │                    │                    │
   ┌────┴────┐          ┌────┴────┐          ┌────┴────┐
   │ 从机 1   │          │ 从机 2   │          │ 从机 N   │
   │ 水塔 1   │          │ 水塔 2   │          │ 水塔 N   │
   │ 液位传感 │          │ 液位传感 │          │ 液位传感 │
   │ 水泵控制 │          │ 水泵控制 │          │ 水泵控制 │
   │ 缺水检测 │          │ 缺水检测 │          │ 缺水检测 │
   └─────────┘          └─────────┘          └─────────┘
```

## 📁 项目结构

```
water_tower_system/
├── esp8266_master/     # ESP8266 主机程序 (Arduino/PlatformIO)
│   └── src/
│       └── main.cpp    # 主程序：WiFi、Web 服务器、LoRa 通信
├── slave_node/         # STC32G 从机程序 (SDCC)
│   └── src/
│       └── main.c      # 从机程序：ADC、继电器、LoRa 通信
├── android_app/        # Android 监控 APP (Kotlin)
│   ├── app/
│   │   └── src/main/java/com/watertower/monitor/
│   │       ├── MainActivity.kt      # 主界面
│   │       ├── ApiService.kt        # API 接口
│   │       └── models.kt            # 数据模型
│   └── build.gradle
├── docs/               # 文档
│   └── 系统设计文档.md  # 完整设计文档
└── pcb/                # PCB 设计文件 (KiCad/EasyEDA)
```

## 🔧 硬件清单

### 主机 (ESP8266 Master)

| 组件 | 型号 | 数量 | 单价 | 小计 |
|------|------|------|------|------|
| ESP8266 模块 | NodeMCU/WeMos D1 | 1 | ¥25 | ¥25 |
| LoRa 模块 | PAN3031 (433MHz) | 1 | ¥35 | ¥35 |
| OLED 显示屏 | 0.96" I2C 128x64 | 1 | ¥15 | ¥15 |
| 缺水传感器 | 光电液位开关 | 1 | ¥20 | ¥20 |
| PCB + 外壳 | 定制 | 1 | ¥50 | ¥50 |
| **合计** | | | | **¥145** |

### 从机 (STC32G Slave)

| 组件 | 型号 | 数量 | 单价 | 小计 |
|------|------|------|------|------|
| 单片机 | STC32G12K128 | 1 | ¥35 | ¥35 |
| LoRa 模块 | PAN3031 (433MHz) | 1 | ¥35 | ¥35 |
| 液位传感器 | 投入式液位变送器 | 1 | ¥80 | ¥80 |
| 继电器模块 | 5V 单路继电器 | 1 | ¥10 | ¥10 |
| 缺水传感器 | 光电液位开关 | 1 | ¥20 | ¥20 |
| 电源模块 | 5V DC-DC | 1 | ¥15 | ¥15 |
| PCB + 外壳 | 定制 | 1 | ¥50 | ¥50 |
| **合计** | | | | **¥245** |

### 其他

| 项目 | 费用 |
|------|------|
| 水泵 (用户自备) | ¥200-500 |
| 水管/阀门 (用户自备) | ¥100-300 |
| 安装辅材 | ¥50 |

**示例配置 (1 主 4 从)**: ¥145 + (¥245 × 4) = **¥1,125**

## 🚀 快速开始

### 1. 编译从机程序 (STC32G)

```bash
cd slave_node
make
# 或使用 SDCC 直接编译
sdcc -mstc32g src/main.c -o build/main.ihx
```

使用 STC-ISP 工具烧录 `build/main.ihx` 到 STC32G12K128。

### 2. 编译主机程序 (ESP8266)

使用 PlatformIO 或 Arduino IDE:

```bash
cd esp8266_master
# 安装 PlatformIO 扩展
# 打开 platformio.ini
# 点击 Build 和 Upload
```

### 3. 编译 Android APP

```bash
cd android_app
# 使用 Android Studio 打开项目
# 或使用命令行:
./gradlew assembleDebug
```

APK 输出位置：`android_app/app/build/outputs/apk/debug/`

### 4. 配置与使用

1. **配置从机地址**: 通过拨码开关设置从机地址 (0x01-0xFE)
2. **上电从机**: 所有从机上电，等待心跳包
3. **上电主机**: ESP8266 连接 WiFi，自动扫描从机
4. **连接 APP**: 手机连接 ESP8266 的 WiFi 热点或同一局域网
5. **访问界面**: 浏览器打开 `http://192.168.4.1` 或 APP 连接

## 📡 通信协议

### LoRa 帧格式

```
| 前导码 (8B) | 地址 (1B) | 命令 (1B) | 数据 (N 字节) | CRC (2B) |
```

### 命令字定义

| 命令 | 值 | 方向 | 说明 |
|------|-----|------|------|
| CMD_HEARTBEAT | 0x01 | 从→主 | 心跳包 (含水位数据) |
| CMD_QUERY | 0x02 | 主→从 | 查询水位 |
| CMD_PUMP_ON | 0x10 | 主→从 | 开启水泵 |
| CMD_PUMP_OFF | 0x11 | 主→从 | 关闭水泵 |
| CMD_SET_AUTO | 0x20 | 主→从 | 设置自动模式 |
| CMD_SET_MANUAL | 0x21 | 主→从 | 设置手动模式 |
| CMD_ALARM | 0xFF | 从→主 | 报警 (缺水/故障) |

### 地址分配

- `0x00`: 主机 (Master)
- `0x01` - `0xFE`: 从机 (Slave)
- `0xFF`: 广播地址

## 🛡️ 安全保护

### 缺水保护

```
┌──────────────┐     ┌──────────────┐
│  主机缺水检测 │────▶│              │
│  (井水检测)   │     │  关闭所有    │
└──────────────┘     │  水泵        │
                     │              │
┌──────────────┐     │              │
│  从机缺水检测 │────▶│              │
│  (进水口检测) │     │              │
└──────────────┘     └──────────────┘
```

### 过载保护

- 连续运行 30 分钟强制停机 5 分钟
- 防止水泵过热损坏

### 通信超时

- 从机 30 秒无心跳 → 标记离线
- 离线从机不参与自动控制

## 📱 Android APP 功能

- ✅ 实时显示各水塔水位
- ✅ 水泵远程开关控制
- ✅ 自动/手动模式切换
- ✅ 历史水位曲线
- ✅ 缺水/故障报警推送
- ✅ 多水塔管理 (最多 8 个)

## 🔗 相关项目

- [PAN3031 驱动库](https://github.com/Wlinuxhv/pan3031-stc32g) - STC32G 版 LoRa 驱动

## 📄 许可证

MIT License

## 👥 贡献

欢迎提交 Issue 和 Pull Request!

---

**开发时间**: 2026 年 2 月  
**作者**: Wlinuxhv  
**联系**: [GitHub](https://github.com/Wlinuxhv)
