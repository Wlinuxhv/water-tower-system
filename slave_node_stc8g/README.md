# STC8G1K08 水塔从机节点

超低功耗水塔监控从机，基于 STC8G1K08 单片机。

## 特性

- **超低功耗**: 睡眠电流 < 10μA
- **低成本**: MCU 成本 ¥8-10
- **长续航**: 电池供电可使用 1-2 年
- **LoRa 通信**: PAN3031 433MHz，距离 1-3km

## 硬件

### 核心元件
- MCU: STC8G1K08 (8KB Flash, 512B RAM, 12MHz)
- LoRa: PAN3031 (SPI 接口)
- 传感器：4-20mA 液位变送器 (ADC 输入)
- 执行器：5V 继电器 (水泵控制)

### 引脚分配
| 功能 | 引脚 | 说明 |
|------|------|------|
| PAN3031 CS | P2.3 | SPI 片选 |
| PAN3031 MOSI | P2.2 | SPI 数据输出 |
| PAN3031 MISO | P2.1 | SPI 数据输入 |
| PAN3031 SCK | P2.0 | SPI 时钟 |
| 水泵继电器 | P3.3 | 数字输出 |
| 缺水检测 | P3.4 | 数字输入 |
| 液位传感器 | P1.0 | ADC 输入 |
| PAN3031 IRQ | P3.2 | 外部中断唤醒 |

### 电源
- 工作电压：5V (继电器和传感器)
- MCU 电压：3.3V (LDO 降压)
- 待机电流：< 10μA
- 工作电流：~5mA

## 编译

### 方法 1: Makefile

```bash
make
```

输出：
- `output/water_slave_stc8g.hex` - HEX 文件
- `output/water_slave_stc8g.bin` - BIN 文件

### 方法 2: SDCC 直接编译

```bash
sdcc --model-small --opt-code-size -Iinc src/main.c src/pan3031.c
```

## 烧录

### 使用 STC-ISP 工具

1. 打开 STC-ISP
2. 选择芯片型号：STC8G1K08
3. 加载 HEX 文件：`output/water_slave_stc8g.hex`
4. 选择 COM 端口
5. 点击"下载/编程"
6. 给板上电 (冷启动)

### 使用 stcgal (命令行)

```bash
stcgal -P stc8g -p COM3 -t 115200 output/water_slave_stc8g.hex
```

## 功耗管理

### 工作模式
- **运行模式**: CPU 全速运行，约 5mA
- **空闲模式**: CPU 暂停，外设运行，约 2mA
- **睡眠模式**: 仅外部中断工作，< 10μA

### 低功耗策略

1. **定时睡眠**: 每 5 秒睡眠一次
2. **中断唤醒**: PAN3031 接收到数据时唤醒
3. **快速处理**: 唤醒后快速完成测量和通信
4. **PAN3031 睡眠**: 不通信时关闭 LoRa 模块

### 功耗计算

假设 5 秒周期：
- 工作 100ms: 5mA × 0.1s = 0.5mAs
- 睡眠 4.9s: 0.01mA × 4.9s = 0.049mAs
- 平均电流：0.549mAs / 5s = 0.11mA

使用 2000mAh 电池：
- 续航：2000mAh / 0.11mA ≈ 18181 小时 ≈ **2 年**

## 配置

### 节点地址

修改 `inc/slave_config.h`:

```c
#define NODE_ID  0x01  // 1-254
```

或使用拨码开关动态设置。

### 通信参数

```c
#define PAN3031_FREQ  434000000  // 频率
#define PAN3031_SF    7          // 扩频因子 (6-12)
#define PAN3031_BW    125000     // 带宽
#define PAN3031_PWR   20         // 功率 (2-17 dBm)
```

### 发送间隔

```c
#define SEND_INTERVAL  5  // 心跳间隔 (秒)
```

## 调试

### 串口输出

如需调试，可添加串口输出 (需占用额外引脚):

```c
void uart_init(void) {
    SCON = 0x50;  // 8 位可变波特率
    TMOD |= 0x20; // 定时器 1 模式 2
    TH1 = 0xFD;   // 9600bps @ 11.0592MHz
    TR1 = 1;
}

void uart_send(uint8_t data) {
    SBUF = data;
    while (!TI);
    TI = 0;
}
```

## 成本

| 元件 | 型号 | 单价 | 数量 | 小计 |
|------|------|------|------|------|
| MCU | STC8G1K08 | ¥8 | 1 | ¥8 |
| LoRa | PAN3031 | ¥35 | 1 | ¥35 |
| 继电器 | 5V 单路 | ¥10 | 1 | ¥10 |
| 传感器 | 4-20mA | ¥80 | 1 | ¥80 |
| PCB+ 外壳 | 定制 | ¥50 | 1 | ¥50 |
| **合计** | | | | **¥183** |

对比 STC32G 方案 (¥245)，**节省 ¥62/台**

## 注意事项

1. **ADC 精度**: 使用内部 2.56V 参考电压
2. **天线匹配**: PAN3031 需要 50Ω 天线
3. **防水**: 野外使用需要防水外壳
4. **防雷**: 天线端加装防雷器
5. **看门狗**: 建议开启看门狗防止死机

## 后续优化

- [ ] 添加电池电压检测
- [ ] 支持太阳能充电
- [ ] 添加 4G 远程通信选项
- [ ] 优化睡眠电流到 < 5μA
